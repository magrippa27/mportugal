---
import { getCollection } from 'astro:content';
import MainLayout from '../../../layouts/MainLayout.astro';
import RadioPostCard from '../../../components/RadioPostCard.astro';
import TobaccoPostCard from '../../../components/TobaccoPostCard.astro';
import AcademicPostCard from '../../../components/AcademicPostCard.astro';
import { type Language, useTranslations } from '../../../i18n/utils';
import { normalizeImagePath } from '../../../utils/images';
import BlogPostContent from '../../../components/react/BlogPostContent';
import client from '../../../../tina/__generated__/client';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  
  return allPosts.map(post => ({
    params: { 
      lang: post.data.language, 
      slug: post.id 
    },
    props: {
      post,
      getTinaProps: async () =>
        client.queries.blog({
          relativePath: post.data.tinaInfo.relativePath,
        }),
    },
  }));
}

const { post, getTinaProps } = Astro.props;
const { lang } = Astro.params as { lang: Language };
const t = useTranslations(lang);
const tinaProps = await getTinaProps();

const allPostsCollection = await getCollection('blog');
const allPosts = allPostsCollection.filter(p => p.data.language === lang);
const relatedPosts = allPosts
  .filter(p => {
    if (p.id === post.id) return false;
    if (!post.data.categories || !p.data.categories) return false;
    return post.data.categories.some(cat => p.data.categories?.includes(cat));
  })
  .slice(0, 3);

const formattedDate = post.data.pubDate.toLocaleDateString(
  lang === 'es' ? 'es-ES' : 'en-US',
  { year: 'numeric', month: 'long', day: 'numeric' }
);

const currentUrl = new URL(Astro.url.pathname, Astro.site);
const shareUrl = currentUrl.toString();
const shareText = encodeURIComponent(`${post.data.title} - ${post.data.description}`);
const whatsappUrl = `https://wa.me/?text=${shareText}%20${encodeURIComponent(shareUrl)}`;
const twitterUrl = `https://twitter.com/intent/tweet?text=${shareText}&url=${encodeURIComponent(shareUrl)}`;

const authorName = 'Manuel de Portugal';
const authorImage = normalizeImagePath('/MDEPORTUAL.jpg');
---

<MainLayout 
  title={post.data.title}
  description={post.data.description}
  lang={lang}
  image={normalizeImagePath(post.data.heroImage || undefined)}
>
  <article class="py-16">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <a 
        href={`${import.meta.env.BASE_URL}${lang}/blog`}
        class="inline-flex items-center text-primary-700 hover:text-primary-900 mb-12 font-medium"
      >
        ‚Üê {t('blog.backToBlog')}
      </a>
      
      {post.data.heroImage && (
        <img 
          src={normalizeImagePath(post.data.heroImage)} 
          alt={post.data.title}
          class="w-full h-96 object-cover rounded-lg mb-12 shadow-lg"
        />
      )}
      
      <header class="mb-12">
        <div class="flex items-center justify-between py-4 border-t border-b border-gray-200">
          <div class="flex items-center gap-4 flex-wrap">
            <img 
              src={authorImage} 
              alt={authorName}
              class="w-8 h-8 rounded-full object-cover"
            />
            <span class="text-sm font-bold text-gray-900">{authorName}</span>
            <span class="text-gray-300">|</span>
            <span class="text-sm text-gray-600">{formattedDate}</span>
            {post.data.categories && post.data.categories.length > 0 && (
              <>
                <span class="text-gray-300">|</span>
                <div class="flex flex-wrap gap-2">
                  {post.data.categories.map(category => (
                    <a 
                      href={`${import.meta.env.BASE_URL}${lang}/blog/category/${category}`}
                      class="text-sm font-medium text-primary-700 hover:text-primary-900"
                    >
                      {t(`blog.category.${category}`)}
                    </a>
                  ))}
                </div>
              </>
            )}
          </div>
          
          <div class="flex items-center gap-3">
            <a 
              href={whatsappUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="p-2 text-gray-600 hover:text-green-600 transition-colors"
              aria-label="Share on WhatsApp"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
              </svg>
            </a>
            <a 
              href={twitterUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="p-2 text-gray-600 hover:text-black transition-colors"
              aria-label="Share on X"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </a>
            <button 
              type="button"
              class="p-2 text-gray-600 hover:text-primary-700 transition-colors"
              aria-label="Share link"
              data-share-url={shareUrl}
              data-share-title={post.data.title}
              data-share-text={post.data.description}
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
            </button>
            <button 
              type="button"
              class="p-2 text-gray-600 hover:text-primary-700 transition-colors"
              aria-label="Copy link"
              data-copy-url={shareUrl}
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            </button>
          </div>
        </div>
        
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mt-8 mb-6">
          {post.data.title}
        </h1>
        
        <p class="text-xl text-gray-600 leading-relaxed mb-8">
          {post.data.description}
        </p>
      </header>
      
      <div class="prose prose-lg max-w-none prose-headings:font-bold prose-a:text-primary-700 prose-a:underline hover:prose-a:text-primary-900 prose-p:break-words">
        <BlogPostContent {...tinaProps} baseUrl={import.meta.env.BASE_URL} client:only="react" />
      </div>
    </div>
    <script is:inline>
      (function() {
        const SCRIPT_ID = 'blog-share-script';
        if (document.getElementById(SCRIPT_ID)) return;
        
        const scriptMarker = document.createElement('div');
        scriptMarker.id = SCRIPT_ID;
        scriptMarker.style.display = 'none';
        document.body.appendChild(scriptMarker);
        
        const initShareButtons = () => {
          const shareButton = document.querySelector('[data-share-url]');
          if (shareButton) {
            const existingHandler = shareButton.getAttribute('data-handler-attached');
            if (!existingHandler) {
              shareButton.setAttribute('data-handler-attached', 'true');
              shareButton.addEventListener('click', async () => {
                const url = shareButton.getAttribute('data-share-url') || '';
                const title = shareButton.getAttribute('data-share-title') || '';
                const text = shareButton.getAttribute('data-share-text') || '';
                
                if (navigator.share) {
                  try {
                    await navigator.share({ title, text, url });
                  } catch (err) {
                    if (err instanceof Error && err.name !== 'AbortError') {
                      console.error('Error sharing:', err);
                    }
                  }
                } else {
                  try {
                    await navigator.clipboard.writeText(url);
                    alert('Link copied to clipboard!');
                  } catch (err) {
                    console.error('Error copying:', err);
                  }
                }
              });
            }
          }
          
          const copyButton = document.querySelector('[data-copy-url]');
          if (copyButton) {
            const existingHandler = copyButton.getAttribute('data-handler-attached');
            if (!existingHandler) {
              copyButton.setAttribute('data-handler-attached', 'true');
              copyButton.addEventListener('click', async () => {
                const url = copyButton.getAttribute('data-copy-url') || '';
                try {
                  await navigator.clipboard.writeText(url);
                  alert('Link copied to clipboard!');
                } catch (err) {
                  console.error('Error copying:', err);
                }
              });
            }
          }
        };
        
        const runInit = () => {
          const shareButton = document.querySelector('[data-share-url]');
          const copyButton = document.querySelector('[data-copy-url]');
          if (shareButton || copyButton) {
            shareButton?.removeAttribute('data-handler-attached');
            copyButton?.removeAttribute('data-handler-attached');
            initShareButtons();
          }
        };
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', runInit);
        } else {
          runInit();
        }
        
        document.addEventListener('astro:page-load', runInit);
      })();
    </script>
  </article>
  
  {relatedPosts.length > 0 && (
    <section class="pt-40 pb-24 bg-neutral">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="border-t-2 border-gray-300 mb-12"></div>
        <h2 class="text-3xl font-bold text-gray-900 mb-8">
          {t('blog.relatedPosts')}
        </h2>
        <div class="grid md:grid-cols-3 gap-8">
          {relatedPosts.map(relatedPost => {
            const hasRadio = relatedPost.data.categories?.includes('radio');
            const hasTobacco = relatedPost.data.categories?.includes('tobacco');
            const PostComponent = hasRadio 
              ? RadioPostCard 
              : hasTobacco 
                ? TobaccoPostCard 
                : AcademicPostCard;
            
            return (
              <PostComponent
                title={relatedPost.data.title}
                description={relatedPost.data.description}
                pubDate={relatedPost.data.pubDate}
                slug={relatedPost.id}
                lang={lang}
                categories={relatedPost.data.categories}
                heroImage={relatedPost.data.heroImage}
              />
            );
          })}
        </div>
      </div>
    </section>
  )}
</MainLayout>

