---
import { getCollection } from 'astro:content';
import MainLayout from '../../../layouts/MainLayout.astro';
import RadioPostCard from '../../../components/RadioPostCard.astro';
import TobaccoPostCard from '../../../components/TobaccoPostCard.astro';
import AcademicPostCard from '../../../components/AcademicPostCard.astro';
import { type Language, useTranslations } from '../../../i18n/utils';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  
  return allPosts.map(post => ({
    params: { 
      lang: post.data.language, 
      slug: post.id 
    },
    props: { post }
  }));
}

const { post } = Astro.props;
const { lang } = Astro.params as { lang: Language };
const t = useTranslations(lang);


const allPostsCollection = await getCollection('blog');
const allPosts = allPostsCollection.filter(p => p.data.language === lang);
const relatedPosts = allPosts
  .filter(p => {
    if (p.id === post.id) return false;
    if (!post.data.categories || !p.data.categories) return false;
    return post.data.categories.some(cat => p.data.categories?.includes(cat));
  })
  .slice(0, 3);

const formattedDate = post.data.pubDate.toLocaleDateString(
  lang === 'es' ? 'es-ES' : 'en-US',
  { year: 'numeric', month: 'long', day: 'numeric' }
);
---

<MainLayout 
  title={post.data.title}
  description={post.data.description}
  lang={lang}
  image={post.data.heroImage || undefined}
>
  <article class="py-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <a 
        href={`${import.meta.env.BASE_URL}${lang}/blog`}
        class="inline-flex items-center text-primary-700 hover:text-primary-900 mb-8 font-medium"
      >
        ‚Üê {t('blog.backToBlog')}
      </a>
      
      {post.data.heroImage && (
        <img 
          src={post.data.heroImage} 
          alt={post.data.title}
          class="w-full h-96 object-cover rounded-lg mb-8 shadow-lg"
        />
      )}
      
      <header class="mb-8">
        <time datetime={post.data.pubDate.toISOString()} class="block text-sm text-gray-500 mb-4">
          {formattedDate}
        </time>
        
        {post.data.categories && post.data.categories.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-4">
            {post.data.categories.map(category => (
              <a 
                href={`${import.meta.env.BASE_URL}${lang}/blog/category/${category}`}
                class="inline-block px-3 py-1 text-sm font-medium rounded-full bg-primary-100 text-primary-800 hover:bg-primary-200 transition-colors"
              >
                {t(`blog.category.${category}`)}
              </a>
            ))}
          </div>
        )}
        
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
          {post.data.title}
        </h1>
        
        <p class="text-xl text-gray-600 leading-relaxed">
          {post.data.description}
        </p>
      </header>
      
      <div class="prose prose-lg max-w-none prose-headings:font-bold prose-a:text-primary-700 prose-a:underline hover:prose-a:text-primary-900" set:html={post.body || ''}>
      </div>
    </div>
  </article>
  
  {relatedPosts.length > 0 && (
    <section class="py-16 bg-neutral">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">
          {t('blog.relatedPosts')}
        </h2>
        <div class="grid md:grid-cols-3 gap-8">
          {relatedPosts.map(relatedPost => {
            const hasRadio = relatedPost.data.categories?.includes('radio');
            const hasTobacco = relatedPost.data.categories?.includes('tobacco');
            const PostComponent = hasRadio 
              ? RadioPostCard 
              : hasTobacco 
                ? TobaccoPostCard 
                : AcademicPostCard;
            
            return (
              <PostComponent
                title={relatedPost.data.title}
                description={relatedPost.data.description}
                pubDate={relatedPost.data.pubDate}
                slug={relatedPost.id}
                lang={lang}
                categories={relatedPost.data.categories}
                heroImage={relatedPost.data.heroImage}
              />
            );
          })}
        </div>
      </div>
    </section>
  )}
</MainLayout>

